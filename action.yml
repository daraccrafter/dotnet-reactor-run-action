name: '.NET Reactor Run'
author: Eziriz
description: 'Runs .NET Reactor based on the operating system of the GitHub Actions runner.'
branding:
  icon: 'shield'
  color: 'blue'
inputs:
  project_file:
    description: 'Path to the .NET Reactor project file.'
    required: false
  input_paths:
    description: 'Comma-separated list of .NET assemblies to obfuscate.'
    required: false
  additional_arguments:
    description: '(Additional) command-line parameters.'
    required: false
  working_directory:
    description: 'Working directory for resolving relative paths.'
    required: false
    default: '.'
  key_file:
    description: 'Path to the strong-name key file (.snk) for signing assemblies.'
    required: false
  license:
    description: 'Provide the .NET Reactor license as either a file path or a base64-encoded string. If no license is defined .NET Reactor runs as demo version.'
    required: false

runs:
  using: "composite"
  steps:
    - name: Check and Install .NET Reactor if needed
      run: |
        os_name=$(echo ${{ runner.os }} | tr '[:upper:]' '[:lower:]')
        reactor_dir="${{ env.DOTNETREACTORROOT }}"

        exe_name="dotNET_Reactor"
        if [[ "${{ runner.os }}" == "Windows" ]]; then
          exe_name="dotNET_Reactor.Console.exe"
        fi

        if [ ! -f "$reactor_dir/$exe_name" ]; then
          echo "Installing latest .NET Reactor version..."

          extract_dir="dotnet_reactor_${os_name}_latest"
          download_url="https://raw.githubusercontent.com/eziriz/ReactorAction/main/versions/${os_name}_latest.zip"

          echo "Downloading .NET Reactor ($download_url)..."
          curl -L $download_url -o dotNetReactor.zip || { echo "Download failed"; exit 1; }

          echo "Unzipping .NET Reactor to ${extract_dir}..."
          if [ "${{ runner.os }}" = "Windows" ]; then
            7z x -y dotNetReactor.zip -o./${extract_dir} || { echo "Unzip failed"; exit 1; }
          else
            unzip dotNetReactor.zip -d ${extract_dir} || { echo "Unzip failed"; exit 1; }
          fi

          echo "DOTNETREACTORROOT=$PWD/${extract_dir}" >> $GITHUB_ENV
        fi
      shell: bash
  - name: Configure License
          run: |
            if [ -n "${{ inputs.license }}" ]; then
              if echo "${{ inputs.license }}" | grep -Eq '(\.license|\.v3lic)$'; then
                cp "${{ inputs.license }}" ${{ env.DOTNETREACTORROOT }}/license.v3lic
              else
                echo "${{ inputs.license }}" | base64 --decode > ${{ env.DOTNETREACTORROOT }}/license.v3lic
              fi
            fi
          shell: bash
    - name: Execute .NET Reactor for multiple files (in-place)
      run: |
        command="${{ env.DOTNETREACTORROOT }}/dotNET_Reactor"

        if [[ "${{ runner.os }}" == "Windows" ]]; then
          command="${{ env.DOTNETREACTORROOT }}/dotNET_Reactor.Console.exe"
        else
          chmod +x "$command"
        fi

        # Change to the working directory if specified
        if [[ -n "${{ inputs.working_directory }}" ]]; then
          echo "Changing to working directory: ${{ inputs.working_directory }}"
          cd "${{ inputs.working_directory }}" || { echo "Failed to change directory"; exit 1; }
        fi

        # Split input_paths into an array
        IFS=',' read -ra FILES <<< "${{ inputs.input_paths }}"

        for file in "${FILES[@]}"; do
          file=$(echo $file | xargs) # Trim spaces
          if [[ -n "$file" ]]; then
            if [[ ! -f "$file" ]]; then
              echo "File not found: $file"
              exit 1
            fi

            args=" -file '$file' -targetfile '$file'" # Same input & output file

            [[ -n "${{ inputs.project_file }}" ]] && args+=" -project '${{ inputs.project_file }}'"
            [[ -n "${{ inputs.key_file }}" ]] && args+=" -snkeypair  '${{ inputs.key_file }}'"
            [[ -n "${{ inputs.additional_arguments }}" ]] && args+=" ${{ inputs.additional_arguments }}"

            echo "Running: $command $args"
            eval "$command $args"
          fi
        done
      shell: bash
